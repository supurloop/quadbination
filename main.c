/* --------------------------------------------------------------------------------------------- */
/* Combo                                                                                         */
/*                                                                                               */
/* Atari 8-bit XL/XE matching game, built using the cc65-2.19 toolchain.                         */
/*                                                                                               */
/* BSD-3-Clause License                                                                          */
/* Copyright 2024 Supurloop Software LLC                                                         */
/*                                                                                               */
/* Redistribution and use in source and binary forms, with or without modification, are          */
/* permitted provided that the following conditions are met:                                     */
/*                                                                                               */
/* 1. Redistributions of source code must retain the above copyright notice, this list of        */
/* conditions and the following disclaimer.                                                      */
/* 2. Redistributions in binary form must reproduce the above copyright notice, this list of     */
/* conditions and the following disclaimer in the documentation and/or other materials provided  */
/* with the distribution.                                                                        */
/* 3. Neither the name of the copyright holder nor the names of its contributors may be used to  */
/* endorse or promote products derived from this software without specific prior written         */
/* permission.                                                                                   */
/*                                                                                               */
/* THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS   */
/* OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF               */
/* MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE    */
/* COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL      */
/* EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE */
/* GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED    */
/* AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING     */
/* NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED  */
/* OF THE POSSIBILITY OF SUCH DAMAGE.                                                            */
/* --------------------------------------------------------------------------------------------- */

/* --------------------------------------------------------------------------------------------- */
/* Build                                                                                         */
/* cl65 --target atari -C .\atari-xex.cfg -O -o Quadbination.xex main.c                          */
/*                                                                                               */
/* To make different tune use RMT to export stripped rmt and then run, incorporate into main.c   */
/* ..\..\xasm-3.1.0-windows\xxd -i .\newmusicstripped.rmt > song.h                               */
/* --------------------------------------------------------------------------------------------- */
// To Build:

/* --------------------------------------------------------------------------------------------- */
/* Includes                                                                                      */
/* --------------------------------------------------------------------------------------------- */
#include <conio.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <atari.h>
#include <peekpoke.h>
#include "cspriteo.h"

#define MUSIC_ENABLED

uint8_t vblanks;
uint8_t comboCount;
uint8_t volume;
uint8_t isRed;
uint8_t pfh;
uint8_t hz = 60;

CSPRITEO_VAR(P1, 1);
CSPRITEO_VAR(P2, 2);
CSPRITEO_VAR(P3, 3);
CSPRITEO_VAR(P4, 0x84);

#pragma data-name (push, "RMTSONGNotPlaying")
unsigned char song_rmt_not_started[] = {
  0xff, 0xff, 0x00, 0x9c, 0x6f, 0x9c, 0x52, 0x4d, 0x54, 0x34, 0x05, 0x10,
  0x01, 0x01, 0x10, 0x9c, 0x12, 0x9c, 0x17, 0x9c, 0x60, 0x9c, 0x1c, 0x9c,
  0x4d, 0x54, 0x57, 0x5a, 0x5d, 0x9c, 0x9c, 0x9c, 0x9c, 0x9c, 0x0c, 0x0c,
  0x2e, 0x2e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff,
  0x18, 0x02, 0xbb, 0x18, 0x00, 0x88, 0x18, 0x01, 0x66, 0x10, 0x00, 0x55,
  0x10, 0x00, 0x44, 0x10, 0x00, 0x33, 0x10, 0x00, 0x22, 0x10, 0x00, 0x22,
  0x10, 0x00, 0x11, 0x10, 0x00, 0x11, 0x10, 0x00, 0x00, 0x10, 0x00, 0x8d,
  0x01, 0x7e, 0x8d, 0x00, 0x7e, 0xff, 0x3e, 0x04, 0xff, 0x3e, 0x04, 0xff,
  0x3e, 0x04, 0xff, 0x3e, 0x04, 0xff, 0x00, 0x02, 0x03, 0x04, 0xfe, 0x00,
  0x60, 0x9c, 0x01, 0xff, 0xff, 0xff, 0xfe, 0x00, 0x60, 0x9c
};
#pragma data-name (pop)

#pragma data-name (push, "RMTSONG")
// Started song
unsigned char song_rmt[] = {
    0xff, 0xff, 0x00, 0x9d, 0x94, 0x9f, 0x52, 0x4d, 0x54, 0x34, 0x40, 0x10,
    0x01, 0x01, 0x10, 0x9d, 0x14, 0x9d, 0xae, 0x9d, 0x85, 0x9f, 0x48, 0x9e,
    0x58, 0x9e, 0x89, 0xd7, 0x25, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x82,
    0x9e, 0x9e, 0x9f, 0x9f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x9f, 0x0c, 0x0c,
    0x0d, 0x0d, 0x00, 0x00, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff,
    0x0c, 0x00, 0x0c, 0x0c, 0x2e, 0x2e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0xff, 0x18, 0x02, 0xbb, 0x18, 0x00, 0x88, 0x18, 0x01,
    0x66, 0x10, 0x00, 0x55, 0x10, 0x00, 0x44, 0x10, 0x00, 0x33, 0x10, 0x00,
    0x22, 0x10, 0x00, 0x22, 0x10, 0x00, 0x11, 0x10, 0x00, 0x11, 0x10, 0x00,
    0x00, 0x10, 0x00, 0x0d, 0x03, 0x7e, 0x03, 0x02, 0xfe, 0x03, 0x01, 0x7e,
    0x0d, 0x03, 0x7e, 0x83, 0x00, 0x83, 0x02, 0xbe, 0x8f, 0x01, 0x7e, 0x16,
    0x03, 0x7e, 0x0f, 0x03, 0xfe, 0x83, 0x01, 0x7e, 0x16, 0x03, 0x7e, 0x0f,
    0x01, 0x0f, 0x03, 0xbe, 0x83, 0x01, 0x7e, 0x0d, 0x03, 0x7e, 0x0f, 0x02,
    0xfe, 0x83, 0x01, 0x7e, 0x0d, 0x03, 0x7e, 0x83, 0x02, 0xfe, 0x8f, 0x01,
    0x7e, 0x16, 0x03, 0x7e, 0x0f, 0x03, 0xfe, 0x83, 0x01, 0x7e, 0x16, 0x03,
    0x7e, 0x0f, 0x01, 0x0f, 0x03, 0xbe, 0x8f, 0x01, 0x7e, 0x16, 0x02, 0x7e,
    0x0f, 0x03, 0xfe, 0x9b, 0x01, 0x7e, 0x16, 0x02, 0x7e, 0x0f, 0x01, 0x0f,
    0x03, 0xbe, 0x9b, 0x01, 0x7e, 0x0a, 0x03, 0x7e, 0x83, 0x02, 0xfe, 0x8f,
    0x01, 0x7e, 0x0a, 0x03, 0x7e, 0x83, 0x00, 0x83, 0x02, 0xbe, 0x9b, 0x01,
    0x7e, 0x16, 0x02, 0x7e, 0x0f, 0x03, 0xfe, 0x96, 0x01, 0x7e, 0x16, 0x02,
    0x7e, 0x0f, 0x03, 0xfe, 0x9b, 0x01, 0x7e, 0x0a, 0x03, 0x7e, 0x83, 0x02,
    0xfe, 0x9b, 0x01, 0x7e, 0x0a, 0x03, 0x7e, 0x1b, 0x01, 0x1b, 0x03, 0xbe,
    0x83, 0x01, 0x7e, 0x0d, 0x07, 0x7e, 0x8d, 0x05, 0x7e, 0x0d, 0x07, 0x7e,
    0x8d, 0x05, 0x7e, 0x0d, 0x07, 0x7e, 0x8d, 0x05, 0x7e, 0x0d, 0x07, 0x7e,
    0x8d, 0x05, 0x7e, 0x0d, 0x05, 0x0d, 0x06, 0x0d, 0x07, 0x7e, 0x0d, 0x05,
    0x0d, 0x06, 0x0d, 0x07, 0x7e, 0x0d, 0x05, 0x0d, 0x06, 0x0d, 0x07, 0x7e,
    0x0d, 0x05, 0x0d, 0x06, 0x0d, 0x07, 0x7e, 0x0d, 0x05, 0xfe, 0x8d, 0x05,
    0xfe, 0x8d, 0x06, 0xfe, 0x0d, 0x07, 0xfe, 0xcd, 0x07, 0x8d, 0x05, 0x0d,
    0x07, 0x7e, 0x8d, 0x05, 0x0d, 0x07, 0x7e, 0x8d, 0x05, 0x0d, 0x07, 0x7e,
    0x8d, 0x05, 0x0d, 0x07, 0x7e, 0x8d, 0x05, 0x0d, 0x07, 0x7e, 0x3e, 0x40,
    0x3e, 0x10, 0xff, 0x00, 0x01, 0x02, 0x03, 0xfe, 0x00, 0x85, 0x9f, 0x99,
    0xff, 0xff, 0xff, 0xfe, 0x00, 0x85, 0x9f
};
#pragma data-name (pop)

#pragma data-name (push, "RMTPLAYER")
unsigned char RMTPLAYER_rmtplayr_obx[] = {
    0xff, 0xff, 0x82, 0xa2, 0xbf, 0xa2, 0x80, 0x00, 0x80, 0x20, 0x80, 0x40,
    0x00, 0xc0, 0x80, 0x80, 0x80, 0xa0, 0x00, 0xc0, 0x40, 0xc0, 0x00, 0x01,
    0x05, 0x0b, 0x00, 0x01, 0xff, 0xff, 0x01, 0x01, 0x00, 0xff, 0xff, 0x00,
    0x01, 0x01, 0x01, 0x00, 0xff, 0xff, 0xff, 0xff, 0x00, 0x01, 0x01, 0x00,
    0x02, 0x03, 0x04, 0x01, 0x06, 0x07, 0x08, 0x09, 0x0a, 0x05, 0x0c, 0x0d,
    0x0e, 0x0f, 0x10, 0x11, 0x12, 0x13, 0x14, 0x0b, 0x00, 0xa3, 0xbf, 0xa3,
    0xbf, 0xb6, 0xaa, 0xa1, 0x98, 0x8f, 0x89, 0x80, 0xf2, 0xe6, 0xda, 0xce,
    0xbf, 0xb6, 0xaa, 0xa1, 0x98, 0x8f, 0x89, 0x80, 0x7a, 0x71, 0x6b, 0x65,
    0x5f, 0x5c, 0x56, 0x50, 0x4d, 0x47, 0x44, 0x3e, 0x3c, 0x38, 0x35, 0x32,
    0x2f, 0x2d, 0x2a, 0x28, 0x25, 0x23, 0x21, 0x1f, 0x1d, 0x1c, 0x1a, 0x18,
    0x17, 0x16, 0x14, 0x13, 0x12, 0x11, 0x10, 0x0f, 0x0e, 0x0d, 0x0c, 0x0b,
    0x0a, 0x09, 0x08, 0x07, 0xff, 0xf1, 0xe4, 0xd8, 0xca, 0xc0, 0xb5, 0xab,
    0xa2, 0x99, 0x8e, 0x87, 0x7f, 0x79, 0x73, 0x70, 0x66, 0x61, 0x5a, 0x55,
    0x52, 0x4b, 0x48, 0x43, 0x3f, 0x3c, 0x39, 0x37, 0x33, 0x30, 0x2d, 0x2a,
    0x28, 0x25, 0x24, 0x21, 0x1f, 0x1e, 0x1c, 0x1b, 0x19, 0x17, 0x16, 0x15,
    0x13, 0x12, 0x11, 0x10, 0x0f, 0x0e, 0x0d, 0x0c, 0x0b, 0x0a, 0x09, 0x08,
    0x07, 0x06, 0x05, 0x04, 0x03, 0x02, 0x01, 0x00, 0xf3, 0xe6, 0xd9, 0xcc,
    0xc1, 0xb5, 0xad, 0xa2, 0x99, 0x90, 0x88, 0x80, 0x79, 0x72, 0x6c, 0x66,
    0x60, 0x5b, 0x55, 0x51, 0x4c, 0x48, 0x44, 0x40, 0x3c, 0x39, 0x35, 0x32,
    0x2f, 0x2d, 0x2a, 0x28, 0x25, 0x23, 0x21, 0x1f, 0x1d, 0x1c, 0x1a, 0x18,
    0x17, 0x16, 0x14, 0x13, 0x12, 0x11, 0x10, 0x0f, 0x0e, 0x0d, 0x0c, 0x0b,
    0x0a, 0x09, 0x08, 0x07, 0x06, 0x05, 0x04, 0x03, 0x02, 0x01, 0x00, 0x00,
    0x00, 0xa4, 0xe1, 0xa8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
    0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
    0x02, 0x02, 0x02, 0x02, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x01, 0x01,
    0x02, 0x02, 0x02, 0x02, 0x02, 0x03, 0x03, 0x03, 0x00, 0x00, 0x01, 0x01,
    0x01, 0x01, 0x02, 0x02, 0x02, 0x02, 0x03, 0x03, 0x03, 0x03, 0x04, 0x04,
    0x00, 0x00, 0x01, 0x01, 0x01, 0x02, 0x02, 0x02, 0x03, 0x03, 0x03, 0x04,
    0x04, 0x04, 0x05, 0x05, 0x00, 0x00, 0x01, 0x01, 0x02, 0x02, 0x02, 0x03,
    0x03, 0x04, 0x04, 0x04, 0x05, 0x05, 0x06, 0x06, 0x00, 0x00, 0x01, 0x01,
    0x02, 0x02, 0x03, 0x03, 0x04, 0x04, 0x05, 0x05, 0x06, 0x06, 0x07, 0x07,
    0x00, 0x01, 0x01, 0x02, 0x02, 0x03, 0x03, 0x04, 0x04, 0x05, 0x05, 0x06,
    0x06, 0x07, 0x07, 0x08, 0x00, 0x01, 0x01, 0x02, 0x02, 0x03, 0x04, 0x04,
    0x05, 0x05, 0x06, 0x07, 0x07, 0x08, 0x08, 0x09, 0x00, 0x01, 0x01, 0x02,
    0x03, 0x03, 0x04, 0x05, 0x05, 0x06, 0x07, 0x07, 0x08, 0x09, 0x09, 0x0a,
    0x00, 0x01, 0x01, 0x02, 0x03, 0x04, 0x04, 0x05, 0x06, 0x07, 0x07, 0x08,
    0x09, 0x0a, 0x0a, 0x0b, 0x00, 0x01, 0x02, 0x02, 0x03, 0x04, 0x05, 0x06,
    0x06, 0x07, 0x08, 0x09, 0x0a, 0x0a, 0x0b, 0x0c, 0x00, 0x01, 0x02, 0x03,
    0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x0a, 0x0a, 0x0b, 0x0c, 0x0d,
    0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x07, 0x08, 0x09, 0x0a,
    0x0b, 0x0c, 0x0d, 0x0e, 0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07,
    0x08, 0x09, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e, 0x0f, 0x4c, 0x0f, 0xa5, 0x4c,
    0xab, 0xa6, 0x4c, 0xc5, 0xa6, 0x4c, 0x4a, 0xa5, 0x4c, 0xac, 0xa8, 0x86,
    0xd3, 0x84, 0xd4, 0x48, 0xa0, 0x85, 0xa9, 0x00, 0x99, 0xdf, 0xa1, 0x88,
    0xd0, 0xfa, 0xa0, 0x04, 0xb1, 0xd3, 0x8d, 0xb9, 0xa6, 0xc8, 0xa0, 0x08,
    0xb1, 0xd3, 0x99, 0xc3, 0x00, 0xc8, 0xc0, 0x10, 0xd0, 0xf6, 0x68, 0x48,
    0x0a, 0x0a, 0x18, 0x65, 0xd1, 0x85, 0xd1, 0x68, 0x08, 0x29, 0xc0, 0x0a,
    0x2a, 0x2a, 0x28, 0x65, 0xd2, 0x85, 0xd2, 0x20, 0x5f, 0xa5, 0xa9, 0x00,
    0x8d, 0x08, 0xd2, 0xa0, 0x03, 0x8c, 0x0f, 0xd2, 0xa0, 0x08, 0x99, 0x00,
    0xd2, 0x88, 0x10, 0xfa, 0xa9, 0x01, 0x60, 0xa2, 0x00, 0x8e, 0xb7, 0xa6,
    0x8a, 0xa8, 0xb1, 0xd1, 0xc9, 0xfe, 0xb0, 0x2d, 0xa8, 0xb1, 0xcd, 0x9d,
    0xe0, 0xa1, 0xb1, 0xcf, 0x9d, 0xe4, 0xa1, 0xa9, 0x00, 0x9d, 0xe8, 0xa1,
    0xa9, 0x01, 0x9d, 0xec, 0xa1, 0xa9, 0x80, 0x9d, 0x14, 0xa2, 0xe8, 0xe0,
    0x04, 0xd0, 0xd9, 0xa5, 0xd1, 0x18, 0x69, 0x04, 0x85, 0xd1, 0x90, 0x1b,
    0xe6, 0xd2, 0x4c, 0xaf, 0xa5, 0xf0, 0x04, 0xa9, 0x00, 0xf0, 0xdf, 0xa0,
    0x02, 0xb1, 0xd1, 0xaa, 0xc8, 0xb1, 0xd1, 0x85, 0xd2, 0x86, 0xd1, 0xa2,
    0x00, 0xf0, 0xb5, 0xa2, 0xff, 0xe8, 0xde, 0xec, 0xa1, 0xd0, 0x42, 0xbd,
    0xe0, 0xa1, 0x85, 0xd3, 0xbd, 0xe4, 0xa1, 0x85, 0xd4, 0xbc, 0xe8, 0xa1,
    0xfe, 0xe8, 0xa1, 0xb1, 0xd3, 0x85, 0xd9, 0x29, 0x3f, 0xc9, 0x3d, 0xf0,
    0x0e, 0xb0, 0x32, 0x9d, 0xf0, 0xa1, 0xc8, 0xb1, 0xd3, 0x4a, 0x29, 0x7e,
    0x9d, 0x14, 0xa2, 0xa9, 0x01, 0x9d, 0xec, 0xa1, 0xbc, 0xe8, 0xa1, 0xfe,
    0xe8, 0xa1, 0xb1, 0xd3, 0x4a, 0x66, 0xd9, 0x4a, 0x66, 0xd9, 0xa5, 0xd9,
    0x29, 0xf0, 0x9d, 0xf4, 0xa1, 0xe0, 0x03, 0xd0, 0xb4, 0xa9, 0x0a, 0x8d,
    0x64, 0xa2, 0x4c, 0x3c, 0xa6, 0xc9, 0x3f, 0xf0, 0x1b, 0xa5, 0xd9, 0x29,
    0xc0, 0xf0, 0x09, 0x0a, 0x2a, 0x2a, 0x9d, 0xec, 0xa1, 0x4c, 0xf9, 0xa5,
    0xc8, 0xb1, 0xd3, 0x9d, 0xec, 0xa1, 0xfe, 0xe8, 0xa1, 0x4c, 0xf9, 0xa5,
    0xa5, 0xd9, 0xc9, 0xff, 0xf0, 0x09, 0xc8, 0xb1, 0xd3, 0x9d, 0xe8, 0xa1,
    0x4c, 0xc1, 0xa5, 0x4c, 0x5f, 0xa5, 0x4c, 0xc5, 0xa6, 0xca, 0x30, 0xfa,
    0xbc, 0x14, 0xa2, 0x30, 0xf8, 0xb1, 0xcb, 0x9d, 0x18, 0xa2, 0x85, 0xd7,
    0xc8, 0xb1, 0xcb, 0x9d, 0x1c, 0xa2, 0x85, 0xd8, 0xa9, 0x01, 0x9d, 0x58,
    0xa2, 0xa0, 0x02, 0xb1, 0xd7, 0x9d, 0x24, 0xa2, 0xc8, 0xb1, 0xd7, 0x9d,
    0x28, 0xa2, 0xc8, 0xb1, 0xd7, 0x9d, 0x40, 0xa2, 0x9d, 0x50, 0xa2, 0xa0,
    0x06, 0xb1, 0xd7, 0x9d, 0x30, 0xa2, 0xa0, 0x08, 0xb1, 0xd7, 0x9d, 0x38,
    0xa2, 0xc8, 0xb1, 0xd7, 0xa8, 0xb9, 0x92, 0xa2, 0x9d, 0x3c, 0xa2, 0xa9,
    0x80, 0x9d, 0x34, 0xa2, 0x9d, 0x14, 0xa2, 0x0a, 0x9d, 0x2c, 0xa2, 0x9d,
    0xfc, 0xa1, 0xa8, 0xb1, 0xd7, 0x9d, 0x4c, 0xa2, 0x69, 0x00, 0x9d, 0x20,
    0xa2, 0xa9, 0x0c, 0x9d, 0x48, 0xa2, 0xa8, 0xb1, 0xd7, 0x9d, 0x44, 0xa2,
    0x4c, 0x39, 0xa6, 0x20, 0xac, 0xa8, 0xce, 0x64, 0xa2, 0xd0, 0x12, 0xee,
    0xb7, 0xa6, 0xa9, 0xff, 0xc9, 0xff, 0xf0, 0x03, 0x4c, 0xaf, 0xa5, 0x4c,
    0x5f, 0xa5, 0x4c, 0x77, 0xa8, 0xa9, 0xa3, 0x85, 0xd6, 0xa2, 0x03, 0xbd,
    0x1c, 0xa2, 0xf0, 0xf2, 0x85, 0xd4, 0xbd, 0x18, 0xa2, 0x85, 0xd3, 0xbc,
    0x20, 0xa2, 0xb1, 0xd3, 0x85, 0xd9, 0xc8, 0xb1, 0xd3, 0x85, 0xda, 0xc8,
    0xb1, 0xd3, 0x85, 0xdb, 0xc8, 0x98, 0xdd, 0x24, 0xa2, 0x90, 0x0a, 0xf0,
    0x08, 0xa9, 0x80, 0x9d, 0x2c, 0xa2, 0xbd, 0x28, 0xa2, 0x9d, 0x20, 0xa2,
    0xa5, 0xd9, 0x29, 0x0f, 0x1d, 0xf4, 0xa1, 0xa8, 0xb9, 0x00, 0xa4, 0x85,
    0xdc, 0xa5, 0xda, 0x29, 0x0e, 0xa8, 0xb9, 0x82, 0xa2, 0x85, 0xd5, 0xa5,
    0xdc, 0x19, 0x83, 0xa2, 0x9d, 0x60, 0xa2, 0xbd, 0x38, 0xa2, 0xf0, 0x1d,
    0xc9, 0x01, 0xd0, 0x16, 0xbd, 0xfc, 0xa1, 0x18, 0xbc, 0x3c, 0xa2, 0x79,
    0x96, 0xa2, 0x9d, 0xfc, 0xa1, 0xb9, 0xab, 0xa2, 0x9d, 0x3c, 0xa2, 0x4c,
    0x3d, 0xa7, 0xde, 0x38, 0xa2, 0xbc, 0x4c, 0xa2, 0xc0, 0x0d, 0x90, 0x30,
    0xbd, 0x50, 0xa2, 0x10, 0x25, 0x98, 0xdd, 0x48, 0xa2, 0xd0, 0x07, 0xa9,
    0x0c, 0x9d, 0x48, 0xa2, 0xd0, 0x03, 0xfe, 0x48, 0xa2, 0xbd, 0x18, 0xa2,
    0x85, 0xd7, 0xbd, 0x1c, 0xa2, 0x85, 0xd8, 0xbc, 0x48, 0xa2, 0xb1, 0xd7,
    0x9d, 0x44, 0xa2, 0xbd, 0x40, 0xa2, 0x38, 0xe9, 0x01, 0x9d, 0x50, 0xa2,
    0xbd, 0x2c, 0xa2, 0x10, 0x18, 0xbd, 0xf4, 0xa1, 0xf0, 0x13, 0xa8, 0xbd,
    0x34, 0xa2, 0x18, 0x7d, 0x30, 0xa2, 0x9d, 0x34, 0xa2, 0x90, 0x06, 0x98,
    0xe9, 0x10, 0x9d, 0xf4, 0xa1, 0xa9, 0x00, 0x85, 0xdd, 0xa5, 0xda, 0x9d,
    0x54, 0xa2, 0x29, 0x70, 0x4a, 0x4a, 0x8d, 0xa2, 0xa7, 0x90, 0xfe, 0x4c,
    0x0e, 0xa8, 0xea, 0x4c, 0xbe, 0xa7, 0xea, 0x4c, 0xc3, 0xa7, 0xea, 0x4c,
    0xcd, 0xa7, 0xea, 0x4c, 0xcd, 0xa7, 0xea, 0x4c, 0xcd, 0xa7, 0xea, 0x4c,
    0xff, 0xa7, 0xa5, 0xdb, 0x4c, 0x2d, 0xa8, 0xa5, 0xdb, 0x85, 0xdd, 0xbd,
    0xf0, 0xa1, 0x4c, 0x14, 0xa8, 0xbd, 0xf0, 0xa1, 0x18, 0x7d, 0x44, 0xa2,
    0xc9, 0x3d, 0x90, 0x02, 0xa9, 0x3f, 0xa8, 0xb1, 0xd5, 0x9d, 0x00, 0xa2,
    0xa4, 0xdb, 0xd0, 0x03, 0x9d, 0x04, 0xa2, 0x98, 0x4a, 0x4a, 0x4a, 0x4a,
    0x9d, 0x08, 0xa2, 0x9d, 0x0c, 0xa2, 0xa5, 0xdb, 0x29, 0x0f, 0x9d, 0x10,
    0xa2, 0xbd, 0xf0, 0xa1, 0x4c, 0x14, 0xa8, 0xa5, 0xdb, 0x18, 0x7d, 0x58,
    0xa2, 0x9d, 0x58, 0xa2, 0xbd, 0xf0, 0xa1, 0x4c, 0x14, 0xa8, 0xbd, 0xf0,
    0xa1, 0x18, 0x65, 0xdb, 0x18, 0x7d, 0x44, 0xa2, 0xc9, 0x3d, 0x90, 0x07,
    0xa9, 0x00, 0x9d, 0x60, 0xa2, 0xa9, 0x3f, 0xa8, 0xb1, 0xd5, 0x18, 0x7d,
    0xfc, 0xa1, 0x18, 0x65, 0xdd, 0x9d, 0x5c, 0xa2, 0xbd, 0x0c, 0xa2, 0xf0,
    0x32, 0xde, 0x0c, 0xa2, 0xd0, 0x2d, 0xbd, 0x08, 0xa2, 0x9d, 0x0c, 0xa2,
    0xbd, 0x04, 0xa2, 0xdd, 0x00, 0xa2, 0xf0, 0x1f, 0xb0, 0x0d, 0x7d, 0x10,
    0xa2, 0xb0, 0x12, 0xdd, 0x00, 0xa2, 0xb0, 0x0d, 0x4c, 0x64, 0xa8, 0xfd,
    0x10, 0xa2, 0x90, 0x05, 0xdd, 0x00, 0xa2, 0xb0, 0x03, 0xbd, 0x00, 0xa2,
    0x9d, 0x04, 0xa2, 0xa5, 0xda, 0x29, 0x01, 0xf0, 0x0a, 0xbd, 0x04, 0xa2,
    0x18, 0x7d, 0xfc, 0xa1, 0x9d, 0x5c, 0xa2, 0xca, 0x30, 0x03, 0x4c, 0xcb,
    0xa6, 0xa2, 0x00, 0x8e, 0xad, 0xa8, 0xad, 0x54, 0xa2, 0x10, 0x1a, 0xad,
    0x60, 0xa2, 0x29, 0x0f, 0xf0, 0x13, 0xad, 0x5c, 0xa2, 0x18, 0x6d, 0x58,
    0xa2, 0x8d, 0x5e, 0xa2, 0xa9, 0x00, 0x8d, 0x62, 0xa2, 0x8a, 0x09, 0x04,
    0xaa, 0xec, 0xad, 0xa8, 0xd0, 0x00, 0x8e, 0xad, 0xa8, 0xa9, 0x01, 0x60,
    0xa0, 0xff, 0xad, 0x5c, 0xa2, 0xae, 0x60, 0xa2, 0x8d, 0x00, 0xd2, 0x8e,
    0x01, 0xd2, 0xad, 0x5d, 0xa2, 0xae, 0x61, 0xa2, 0x8d, 0x02, 0xd2, 0x8e,
    0x03, 0xd2, 0xad, 0x5e, 0xa2, 0xae, 0x62, 0xa2, 0x8d, 0x04, 0xd2, 0x8e,
    0x05, 0xd2, 0xad, 0x5f, 0xa2, 0xae, 0x63, 0xa2, 0x8d, 0x06, 0xd2, 0x8e,
    0x07, 0xd2, 0x8c, 0x08, 0xd2, 0x60
};
#pragma data-name (pop)

#define GAME_STARTED 0
#define GAME_NOT_STARTED 1
#define GAME_STARTING 2
uint8_t gameState = GAME_NOT_STARTED;


#define RMTPlayer 0xA500	// location of the player in memory
#define RMTSong song_rmt
#define RMTSongNotPlaying song_rmt_not_started

#define RMTInit	__asm__("lda #0");	\
    			__asm__("ldx #(<%v)", RMTSong);	\
    			__asm__("ldy #(>%v)", RMTSong);	\
    			__asm__("jsr %w", RMTPlayer);

#define RMTInitNotPlaying	__asm__("lda #0");	\
    			__asm__("ldx #(<%v)", RMTSongNotPlaying);	\
    			__asm__("ldy #(>%v)", RMTSongNotPlaying);	\
    			__asm__("jsr %w", RMTPlayer);


#define RMTPlay  __asm__("jsr %w+3", RMTPlayer);
#define RMTStop  __asm__("jsr %w+9", RMTPlayer);

uint8_t unlatch = 0;

uint8_t rli2;
uint8_t rl2[] = {
    11, 4, 0, 9, 7, 14, 3, 5, 2, 6, 8, 13, 1, 12, 10, 15,
    6, 1, 5, 13, 9, 10, 14, 2, 11, 15, 0, 8, 4, 12, 7, 3,
    3, 8, 10, 13, 5, 11, 2, 7, 1, 0, 12, 14, 15, 6, 9, 4,
    10, 11, 13, 3, 7, 0, 15, 9, 4, 5, 2, 12, 14, 1, 8, 6,
    9, 1, 2, 0, 6, 8, 10, 15, 13, 7, 12, 3, 11, 4, 14, 5,
    14, 13, 8, 5, 11, 4, 10, 15, 12, 6, 0, 2, 9, 1, 3, 7,
    14, 4, 3, 6, 13, 7, 1, 11, 15, 9, 5, 2, 12, 10, 0, 8,
    6, 12, 1, 11, 8, 14, 0, 2, 4, 15, 9, 5, 3, 13, 10, 7,
    14, 0, 8, 3, 4, 13, 9, 11, 2, 12, 1, 15, 6, 5, 10, 7,
    12, 5, 14, 7, 3, 10, 13, 8, 11, 15, 1, 4, 6, 9, 0, 2,
    10, 7, 12, 5, 11, 3, 14, 15, 9, 6, 8, 2, 0, 1, 13, 4,
    0, 4, 2, 8, 14, 10, 1, 5, 12, 6, 9, 11, 15, 7, 3, 13,
    6, 0, 13, 12, 2, 10, 3, 4, 1, 15, 14, 9, 7, 11, 8, 5,
    4, 13, 15, 3, 9, 2, 8, 0, 12, 7, 6, 1, 14, 11, 5, 10,
    11, 13, 10, 5, 8, 12, 14, 15, 3, 0, 9, 4, 2, 7, 1, 6,
    9, 10, 0, 7, 3, 14, 1, 2, 15, 13, 12, 11, 6, 8, 5, 4
};

uint8_t rli;
uint8_t rl[] = {
    6, 5, 2, 15, 11, 8, 4, 14, 1, 7, 3, 12, 9, 10, 13, 0,
    4, 6, 8, 12, 5, 7, 9, 1, 11, 3, 14, 2, 0, 10, 13, 15,
    3, 6, 11, 2, 1, 15, 7, 8, 0, 10, 14, 4, 12, 13, 5, 9,
    9, 12, 15, 3, 11, 7, 13, 1, 2, 10, 6, 4, 0, 8, 14, 5,
    14, 8, 11, 10, 5, 2, 15, 6, 1, 9, 4, 13, 7, 0, 12, 3,
    0, 15, 10, 9, 4, 14, 6, 13, 8, 1, 12, 3, 2, 7, 11, 5,
    15, 6, 1, 0, 10, 4, 5, 12, 7, 11, 3, 8, 14, 2, 13, 9,
    10, 7, 1, 13, 11, 12, 15, 6, 4, 2, 5, 8, 0, 14, 9, 3,
    11, 13, 10, 4, 2, 5, 1, 14, 7, 8, 6, 12, 3, 15, 9, 0,
    12, 1, 5, 8, 13, 9, 4, 14, 10, 3, 0, 11, 7, 6, 15, 2,
    5, 14, 11, 0, 7, 3, 15, 13, 9, 1, 12, 10, 2, 4, 6, 8,
    10, 3, 0, 5, 14, 7, 9, 12, 6, 13, 8, 11, 15, 4, 1, 2,
    9, 5, 15, 11, 6, 10, 0, 4, 2, 7, 1, 12, 14, 3, 8, 13,
    11, 5, 4, 15, 8, 1, 7, 13, 2, 14, 10, 3, 0, 9, 6, 12,
    11, 7, 8, 3, 2, 1, 15, 5, 12, 6, 14, 13, 4, 10, 9, 0,
    11, 1, 7, 5, 12, 2, 10, 14, 4, 3, 15, 8, 9, 13, 0, 6
};

uint8_t rtmp;

#define RANDASM(rlist, rindex, nr) { \
    nr = rlist[rindex]; \
    rtmp = nr >> 1; \
    if ((nr & 0x01) == 0x01) rtmp |= 0x08; \
    rlist[rindex] = rtmp; \
    rindex++; \
}

uint8_t *ptr;
#define RANDINIT(rindex) { \
    rindex = 0; \
    ptr = (uint8_t *)0xd200; \
    do { \
        rindex ^= *ptr; \
        ptr++; \
    } while (ptr < (uint8_t *)0xd300); \
}

/* --------------------------------------------------------------------------------------------- */
/* Macros                                                                                        */
/* --------------------------------------------------------------------------------------------- */
#define STRIG0 0x0284  //Trigger button
#define STRIG1 0x0285  //Trigger button
#define STICK0 0x0278  //Joystick address
#define STICK1 0x0279  //Joystick address

#define HITCLR 0xD01E
#define BGCOLOR 0xD01A
#define COLPF0 0xD016
#define COLPF1 0xD017
#define COLPF2 0xD018
#define COLPF3 0xD019
#define COLPF4 0xD01a

#define P0PF 0xD004
#define SIZEP0 0xD008

#define PADDL0 0x0270
#define PADDL1 0x0271
#define PADDL2 0x0272
#define PADDL3 0x0273

#define PTRIG0 0x027C
#define PTRIG1 0x027D
#define PTRIG2 0x027E
#define PTRIG3 0x027F

#define RANDOM (0xd208)

char *p = (char *)0x8000;


#define NUM_COLUMNS 40
#define NUM_STATUS_COLUMNS 40
#define NUM_ROWS 16
#define ROW_ADDR_OFF 3

#define HPOSM0 0xd004
#define SIZEM 0xd00c

#define NUM_PLAYER_DATA (16u)
const uint8_t charPlayerData[4][NUM_PLAYER_DATA][8] =
{
    /* Player 1 Color */
    {
        { 0x00, 0x04, 0x11, 0x11, 0x11, 0x11, 0x11, 0x04 }, /* 0 */
        { 0x00, 0x04, 0x14, 0x04, 0x04, 0x04, 0x04, 0x15 }, /* 1 */
        { 0x00, 0x04, 0x11, 0x01, 0x04, 0x10, 0x10, 0x15 }, /* 2 */
        { 0x00, 0x14, 0x01, 0x01, 0x15, 0x01, 0x01, 0x14 }, /* 3 */
        { 0x00, 0x11, 0x11, 0x11, 0x05, 0x01, 0x01, 0x01 }, /* 4 */
        { 0x00, 0x05, 0x10, 0x10, 0x15, 0x01, 0x01, 0x14 }, /* 5 */
        { 0x00, 0x04, 0x10, 0x10, 0x14, 0x11, 0x11, 0x04 }, /* 6 */
        { 0x00, 0x15, 0x01, 0x01, 0x04, 0x04, 0x04, 0x04 }, /* 7 */
        { 0x00, 0x04, 0x11, 0x11, 0x15, 0x11, 0x11, 0x04 }, /* 8 */
        { 0x00, 0x04, 0x11, 0x11, 0x05, 0x01, 0x01, 0x04 }, /* 9 */
        { 0x00, 0x04, 0x11, 0x11, 0x15, 0x11, 0x11, 0x11 }, /* A */
        { 0x00, 0x14, 0x11, 0x11, 0x15, 0x11, 0x11, 0x14 }, /* B */
        { 0x00, 0x05, 0x10, 0x10, 0x10, 0x10, 0x10, 0x05 }, /* C */
        { 0x00, 0x14, 0x11, 0x11, 0x11, 0x11, 0x11, 0x14 }, /* D */
        { 0x00, 0x05, 0x10, 0x10, 0x15, 0x10, 0x10, 0x05 }, /* E */
        { 0x00, 0x05, 0x10, 0x10, 0x15, 0x10, 0x10, 0x10 }, /* F */
    },
    /* Player 2 */
    {
        { 0x00, 0x08, 0x22, 0x22, 0x22, 0x22, 0x22, 0x08 },
        { 0x00, 0x08, 0x28, 0x08, 0x08, 0x08, 0x08, 0x2A },
        { 0x00, 0x08, 0x22, 0x02, 0x08, 0x20, 0x20, 0x2A },
        { 0x00, 0x28, 0x02, 0x02, 0x2A, 0x02, 0x02, 0x28 },
        { 0x00, 0x22, 0x22, 0x22, 0x0A, 0x02, 0x02, 0x02 },
        { 0x00, 0x0A, 0x20, 0x20, 0x2A, 0x02, 0x02, 0x28 },
        { 0x00, 0x08, 0x20, 0x20, 0x28, 0x22, 0x22, 0x08 },
        { 0x00, 0x2A, 0x02, 0x02, 0x08, 0x08, 0x08, 0x08 },
        { 0x00, 0x08, 0x22, 0x22, 0x2A, 0x22, 0x22, 0x08 },
        { 0x00, 0x08, 0x22, 0x22, 0x0A, 0x02, 0x02, 0x08 },
        { 0x00, 0x08, 0x22, 0x22, 0x2A, 0x22, 0x22, 0x22 },
        { 0x00, 0x28, 0x22, 0x22, 0x2A, 0x22, 0x22, 0x28 },
        { 0x00, 0x0A, 0x20, 0x20, 0x20, 0x20, 0x20, 0x0A },
        { 0x00, 0x28, 0x22, 0x22, 0x22, 0x22, 0x22, 0x28 },
        { 0x00, 0x0A, 0x20, 0x20, 0x2A, 0x20, 0x20, 0x0A },
        { 0x00, 0x0A, 0x20, 0x20, 0x2A, 0x20, 0x20, 0x20 },
    },
    /* Player 3/4 */
    {
        { 0x00, 0x0C, 0x33, 0x33, 0x33, 0x33, 0x33, 0x0C },
        { 0x00, 0x0C, 0x3C, 0x0C, 0x0C, 0x0C, 0x0C, 0x3F },
        { 0x00, 0x0C, 0x33, 0x03, 0x0C, 0x30, 0x30, 0x3F },
        { 0x00, 0x3C, 0x03, 0x03, 0x3F, 0x03, 0x03, 0x3C },
        { 0x00, 0x33, 0x33, 0x33, 0x0F, 0x03, 0x03, 0x03 },
        { 0x00, 0x0F, 0x30, 0x30, 0x3F, 0x03, 0x03, 0x3C },
        { 0x00, 0x0C, 0x30, 0x30, 0x3C, 0x33, 0x33, 0x0C },
        { 0x00, 0x3F, 0x03, 0x03, 0x0C, 0x0C, 0x0C, 0x0C },
        { 0x00, 0x0C, 0x33, 0x33, 0x3F, 0x33, 0x33, 0x0C },
        { 0x00, 0x0C, 0x33, 0x33, 0x0F, 0x03, 0x03, 0x0C },
        { 0x00, 0x0C, 0x33, 0x33, 0x3F, 0x33, 0x33, 0x33 },
        { 0x00, 0x3C, 0x33, 0x33, 0x3F, 0x33, 0x33, 0x3C },
        { 0x00, 0x0F, 0x30, 0x30, 0x30, 0x30, 0x30, 0x0F },
        { 0x00, 0x3C, 0x33, 0x33, 0x33, 0x33, 0x33, 0x3C },
        { 0x00, 0x0F, 0x30, 0x30, 0x3F, 0x30, 0x30, 0x0F },
        { 0x00, 0x0F, 0x30, 0x30, 0x3F, 0x30, 0x30, 0x30 },
    },
    /* Player 3/4 */
    {
        { 0x00, 0x0C, 0x33, 0x33, 0x33, 0x33, 0x33, 0x0C },
        { 0x00, 0x0C, 0x3C, 0x0C, 0x0C, 0x0C, 0x0C, 0x3F },
        { 0x00, 0x0C, 0x33, 0x03, 0x0C, 0x30, 0x30, 0x3F },
        { 0x00, 0x3C, 0x03, 0x03, 0x3F, 0x03, 0x03, 0x3C },
        { 0x00, 0x33, 0x33, 0x33, 0x0F, 0x03, 0x03, 0x03 },
        { 0x00, 0x0F, 0x30, 0x30, 0x3F, 0x03, 0x03, 0x3C },
        { 0x00, 0x0C, 0x30, 0x30, 0x3C, 0x33, 0x33, 0x0C },
        { 0x00, 0x3F, 0x03, 0x03, 0x0C, 0x0C, 0x0C, 0x0C },
        { 0x00, 0x0C, 0x33, 0x33, 0x3F, 0x33, 0x33, 0x0C },
        { 0x00, 0x0C, 0x33, 0x33, 0x0F, 0x03, 0x03, 0x0C },
        { 0x00, 0x0C, 0x33, 0x33, 0x3F, 0x33, 0x33, 0x33 },
        { 0x00, 0x3C, 0x33, 0x33, 0x3F, 0x33, 0x33, 0x3C },
        { 0x00, 0x0F, 0x30, 0x30, 0x30, 0x30, 0x30, 0x0F },
        { 0x00, 0x3C, 0x33, 0x33, 0x33, 0x33, 0x33, 0x3C },
        { 0x00, 0x0F, 0x30, 0x30, 0x3F, 0x30, 0x30, 0x0F },
        { 0x00, 0x0F, 0x30, 0x30, 0x3F, 0x30, 0x30, 0x30 },
    }
};

uint8_t ptmp;
uint8_t ptmp2;
uint8_t ptmp3;
uint8_t paddle1;
uint8_t paddle2;
uint8_t paddle3;
uint8_t paddle4;

uint8_t tmp;


/* 1KB Aligned for Antic */
#pragma bss-name ("ROW_SEGMENT")
char rows[NUM_ROWS][NUM_COLUMNS];
char filter[NUM_COLUMNS];
char status1[NUM_STATUS_COLUMNS] = "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x31uadbination\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00";
char status2[NUM_STATUS_COLUMNS];
char status4[NUM_STATUS_COLUMNS];// = "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00";;
char status3[NUM_STATUS_COLUMNS];
#pragma bss-name ("BSS")

unsigned char currClockFrame = 0;
unsigned char mainbgcolor = 0x0e;
uint8_t isAdd1;
uint8_t isAdd2;
uint8_t isAdd3;
uint8_t isAdd4;
uint8_t newScore1Bcd[2];
uint8_t newScore2Bcd[2];
uint8_t newScore3Bcd[2];
uint8_t newScore4Bcd[2];

const void dlist =
{
    DL_DLI(DL_VSCROL(DL_BLK8)), // starting dli
    DL_VSCROL(DL_BLK8),
    DL_VSCROL(DL_BLK4),
    DL_VSCROL(DL_BLK8),
    (DL_VSCROL(DL_BLK8)),
    (DL_VSCROL(DL_LMS(DL_CHR40x8x4))),
    &rows[0],
    (DL_VSCROL(DL_LMS(DL_CHR40x8x4))),
    &rows[1],
    DL_DLI(DL_VSCROL(DL_LMS(DL_CHR40x8x4))), //music
    &rows[2],
    (DL_VSCROL(DL_LMS(DL_CHR40x8x4))),
    &rows[3],
    DL_VSCROL(DL_LMS(DL_CHR40x8x4)),
    &rows[4],
    DL_VSCROL(DL_LMS(DL_CHR40x8x4)),
    &rows[5],
    (DL_VSCROL(DL_LMS(DL_CHR40x8x4))),
    &rows[6],
    (DL_VSCROL(DL_LMS(DL_CHR40x8x4))),
    &rows[7],
    DL_DLI(DL_VSCROL(DL_LMS(DL_CHR40x8x4))), // ghost
    &rows[8],
    DL_VSCROL(DL_LMS(DL_CHR40x8x4)),
    &rows[9],
    DL_VSCROL(DL_LMS(DL_CHR40x8x4)),
    &rows[10],
    DL_VSCROL(DL_LMS(DL_CHR40x8x4)),
    &rows[11],
    DL_VSCROL(DL_LMS(DL_CHR40x8x4)),
    &rows[12],
    DL_VSCROL(DL_LMS(DL_CHR40x8x4)),
    &rows[13],
    DL_DLI(DL_VSCROL(DL_LMS(DL_CHR40x8x4))), // dial combination
    &rows[14],
    (DL_VSCROL(DL_LMS(DL_CHR40x8x4))),
    &rows[15],
    DL_DLI(DL_VSCROL(DL_BLK4)), // player location
    (DL_VSCROL(DL_BLK2)),
    (DL_LMS(DL_CHR40x8x4)),
    filter,
    DL_DLI(DL_BLK2), // score board
    (DL_LMS(DL_CHR40x8x1)),
    status1,
    DL_BLK4,
    (DL_LMS(DL_CHR40x8x1)),
    status3,
    (DL_LMS(DL_CHR40x8x1)),
    status4,
    DL_JVB,
    0x0600,
};

uint8_t tmp2;
uint8_t tmp3;
uint8_t hpos0;
uint8_t sizep0;
uint8_t tmp4;
#define PADDLE_HYS (3u)

#define PADDLE_UPDATE(sname, lastPaddle, paddlePort, paddleTrig) { \
    if (CSPRITE_ENABLED(sname)) { \
    tmp = PEEK(paddlePort); \
    tmp2 = PEEK(paddleTrig); \
    if (tmp < lastPaddle) \
        { if ((lastPaddle - tmp) < PADDLE_HYS) tmp = lastPaddle; } \
    else if (tmp > lastPaddle) \
        { if ((tmp - lastPaddle) < PADDLE_HYS) tmp = lastPaddle; } \
    lastPaddle = tmp; \
    if (tmp <= 34) tmp = 39; \
    else if (tmp >= 194) tmp = 0; \
    else { tmp = (tmp - 34) >> 2; tmp = 39 - tmp; } \
    xcharoff_new_##sname = tmp; \
    if ((tmp2 == 0)) { if ((tmp3 & 0x01) == 0) ycharoff_new_##sname++; } \
    else { if ((tmp3 & 0x1f) == 0) ycharoff_new_##sname++; } \
    }}

void dli_routine(void);
uint8_t np = 1;
uint8_t *p1;
uint8_t *d1;

#define NEW_PLAYER_DIGIT(sname, i) { \
    RANDASM(rl2, rli2, np); \
    memcpy(&p[(code_##sname & 0x7f) << 3], &charPlayerData[i][np], 8); \
    digit_##sname = np; \
    masked_##sname = 0; \
}

void dli_routine2(void)
{
    asm("pha");
    asm("txa");
    asm("pha");

    ANTIC.wsync = 0;
    POKE(BGCOLOR, 0);

    POKE(COLPF2, 0); // Scoreboard color

    ANTIC.chbase = 0xE0;
    OS.chbas = 0xE0;
    ANTIC.wsync = 0;

    tmp3++;
    GTIA_WRITE.hposp0 = 48;
    GTIA_WRITE.colpm0 = OS.color0;
    GTIA_WRITE.sizep0 = 3;
    GTIA_WRITE.hposp1 = 80;
    GTIA_WRITE.colpm1 = OS.color1;
    GTIA_WRITE.sizep1 = 3;
    GTIA_WRITE.hposp2 = 144;
    GTIA_WRITE.colpm2 = OS.color2;
    GTIA_WRITE.sizep2 = 3;
    GTIA_WRITE.hposp3 = 176;
    GTIA_WRITE.colpm3 = OS.color3;
    GTIA_WRITE.sizep3 = 3;


    ANTIC.wsync = 0;
    ANTIC.wsync = 0;
    ANTIC.wsync = 0;
    ANTIC.wsync = 0;
    ANTIC.wsync = 0;
    ANTIC.wsync = 0;
    ANTIC.wsync = 0;
    ANTIC.wsync = 0;
    ANTIC.wsync = 0;


    GTIA_WRITE.grafp0 = 0xff;
    GTIA_WRITE.grafp1 = 0xff;
    GTIA_WRITE.grafp2 = 0xff;
    GTIA_WRITE.grafp3 = 0xff;

    unlatch = 1;
    OS.vdslst = &dli_routine;

    asm("pla");
    asm("tax");
    asm("pla");
    asm("rti");
}

void dli_routine1bb(void)
{
    asm("pha");
    asm("txa");
    asm("pha");

    GTIA_WRITE.sizem = 0x55;
    ANTIC.wsync = 0;
    POKE(BGCOLOR, 8);
    GTIA_WRITE.colpm0 = OS.color0;
    if (CSPRITE_ENABLED(P1)) GTIA_WRITE.grafm = 0x03;
    else GTIA_WRITE.grafm = 0;
    ANTIC.wsync = 0;
    GTIA_WRITE.colpm1 = OS.color1;
    if (CSPRITE_ENABLED(P2)) GTIA_WRITE.grafm = 0x0c;
    else GTIA_WRITE.grafm = 0;
    ANTIC.wsync = 0;
    GTIA_WRITE.colpm2 = OS.color2;
    if (CSPRITE_ENABLED(P3)) GTIA_WRITE.grafm = 0x30;
    else GTIA_WRITE.grafm = 0;
    ANTIC.wsync = 0;
    GTIA_WRITE.colpm3 = OS.color3;
    if (CSPRITE_ENABLED(P4)) GTIA_WRITE.grafm = 0xc0;
    else GTIA_WRITE.grafm = 0;
    ANTIC.wsync = 0;
    GTIA_WRITE.grafm = 0x00;

    POKE(BGCOLOR, 6);
    if (hz == 50) POKE(COLPF0, 0x38);
    else POKE(COLPF0, 0x48);
    POKE(COLPF1, 0xc8);
    POKE(COLPF2, 2); // Scoreboard color

    OS.vdslst = &dli_routine2;

    asm("pla");
    asm("tax");
    asm("pla");
    asm("rti");
}

void dli_routine1(void)
{
    asm("pha");
    asm("txa");
    asm("pha");

    ANTIC.wsync = 0;
    POKE(BGCOLOR, 0x06);
    ANTIC.wsync = 0;
    ANTIC.wsync = 0;
    ANTIC.wsync = 0;

    OS.vdslst = &dli_routine1bb;
    asm("pla");
    asm("tax");
    asm("pla");
    asm("rti");
}

uint8_t PMSpriteGhost[] =
{
    0x3c,
    0x7e,
    0x99,
    0xBB,
    0xff,
    0xff,
    0xff,
    0xaa,
    0x00,
};
uint8_t loop;
uint8_t rainbow;

#define PLAYER_START(sname, ptrig) { \
    if (PEEK(ptrig) == 0) { buttonCount_##sname++; } else buttonCount_##sname = 0; \
    if ((buttonCountLast_##sname > 0) && (buttonCountLast_##sname < 31) && (buttonCount_##sname == 0)) { enabled_##sname = 1; } \
    if (timerStarted == 0) { \
        if (enabled_##sname) { if (buttonCount_##sname > 180) { timerStarted = 1; } } \
        if (timerStarted) { \
            memset(filter, 0, NUM_COLUMNS); \
            vblanks = 0; \
            timer[0] = 0x03; \
            timer[1] = 0x00; \
            CSPRITE_UNDRAW(P4); \
            CSPRITE_UNDRAW(P3); \
            CSPRITE_UNDRAW(P2); \
            CSPRITE_UNDRAW(P1); \
            CSPRITE_YCHAROFF_NEW(P1) = 0; \
            CSPRITE_YCHAROFF_NEW(P2) = 0; \
            CSPRITE_YCHAROFF_NEW(P3) = 0; \
            CSPRITE_YCHAROFF_NEW(P4) = 0; \
            RMTInit; \
            waitForVBLANKold(); \
            memset(&rows[NUM_ROWS - 1], 0, NUM_COLUMNS); \
            UpdateStatusBCD(status1, 36, timer); \
            gameState = GAME_STARTING; \
        } \
    } \
}
#define SLOWDOWN_TIME 0x07
uint8_t slowdown;
uint8_t playerHitColor;
void dli_routinea(void)
{
    asm("pha");
    asm("txa");
    asm("pha");

    ANTIC.wsync = 0;

    POKE(BGCOLOR, OS.color4);
    loop = 0;
    while (loop < sizeof(PMSpriteGhost))
    {
        if (sizep0 != 0) rainbow = playerHitColor;
        else rainbow++;
        ANTIC.wsync = 0;
        GTIA_WRITE.grafp0 = PMSpriteGhost[loop];
        GTIA_WRITE.colpm0 = rainbow;
        if (sizep0 == 0)
        {loop++; continue; }

        ANTIC.wsync = 0;
        GTIA_WRITE.grafp0 = PMSpriteGhost[loop];
        if (sizep0 == 1)
        {loop++; continue; }

        ANTIC.wsync = 0;
        GTIA_WRITE.grafp0 = PMSpriteGhost[loop];

        ANTIC.wsync = 0;
        GTIA_WRITE.grafp0 = PMSpriteGhost[loop];
        loop++;
    }
    
    OS.vdslst = &dli_routine1;
    asm("pla");
    asm("tax");
    asm("pla");
    asm("rti");
}

void dli_routinemusic(void)
{
    asm("pha");
    asm("txa");
    asm("pha");
    asm("tya");
    asm("pha");

    ANTIC.wsync = 0;
    ANTIC.wsync = 0;
    ANTIC.wsync = 0;

#ifdef MUSIC_ENABLED        
    RMTPlay;
#endif
    OS.vdslst = &dli_routinea;

    asm("pla");
    asm("tay");
    asm("pla");
    asm("tax");
    asm("pla");
    asm("rti");
}

void dli_routine(void)
{
    asm("pha");
    asm("txa");
    asm("pha");

    GTIA_WRITE.grafp0 = 0;
    GTIA_WRITE.grafp1 = 0;
    GTIA_WRITE.grafp2 = 0;
    GTIA_WRITE.grafp3 = 0;
    GTIA_WRITE.sizep0 = sizep0;
    GTIA_WRITE.hposp0 = hpos0;
    GTIA_WRITE.hitclr = 1;

    OS.vdslst = &dli_routinemusic;
    ANTIC.chbase = 0x80;
    OS.chbas = 0x80;

    asm("pla");
    asm("tax");
    asm("pla");
    asm("rti");
}

/* --------------------------------------------------------------------------------------------- */
/* Waits for vblank.                                                                             */
/* --------------------------------------------------------------------------------------------- */
#define waitForVBLANKold() { \
    currClockFrame = OS.rtclok[2]; \
    while (OS.rtclok[2] == currClockFrame); \
}

#define waitForVBLANK() { \
    while (unlatch == 0); \
    unlatch = 0; \
}

uint8_t teamScore[2];
uint8_t p1Score[2];
uint8_t p2Score[2];
uint8_t p3Score[2];
uint8_t p4Score[2];

uint8_t teamScoreHi[2];
uint8_t p1ScoreHi[2];
uint8_t p2ScoreHi[2];
uint8_t p3ScoreHi[2];
uint8_t p4ScoreHi[2];

uint8_t timerStarted;

uint8_t timer[2];

#define BCD_ADD(va, plus, line) \
        __asm__("sed"); \
        __asm__("clc"); \
        __asm__("ldx #$00"); \
        __asm__("lda %v,x", va); \
        __asm__("adc %v", plus); \
        __asm__("sta %v,x", va); \
        __asm__("bcc %g", va##line); \
        __asm__("ldx #$01"); \
        __asm__("lda %v,x", va); \
        __asm__("adc #$00"); \
        __asm__("sta %v,x", va); \
va##line: \
        __asm__("cld");

#define BCD_SUB(va, minus) \
    __asm__("sed"); \
    __asm__("sec"); \
    __asm__("ldx #$00"); \
    __asm__("lda %v,x", va); \
    __asm__("sbc %v", minus); \
    __asm__("sta %v,x", va); \
    __asm__("ldx #$01"); \
    __asm__("lda %v,x", va); \
    __asm__("sbc #$00"); \
    __asm__("sta %v,x", va); \
    __asm__("cld");

#define UPDATE_SCORE(score, newScoreBdc, isAdd, sname, statoff, line2) { \
        if (isAdd) { BCD_ADD(score, newScoreBdc, line2); } \
        else { \
            if ((score[1] == 0) && (score[0] <= newScoreBdc[0])) score[0] = 0; \
            else { BCD_SUB(score, newScoreBdc); } \
            } \
        newScoreBdc[0] = 0; \
}

/* --------------------------------------------------------------------------------------------- */
/* Updates status at offset with BCD value                                                       */
/* --------------------------------------------------------------------------------------------- */
#define UpdateStatusBCD(status, offset, va) { \
    status[offset]     = 0x10 + (va[1] >> 4); \
    status[offset + 1] = 0x10 + (va[1] & 0x0f); \
    status[offset + 2] = 0x10 + (va[0] >> 4); \
    status[offset + 3] = 0x10 + (va[0] & 0x0f); }

uint8_t r;
uint16_t r16;
uint8_t c;
uint16_t tmp16;

#define UPDATE_HIGH_SCORE(s, h) { \
    if ((s[1] > h[1]) || ((s[1] == h[1]) && (s[0] > h[0]))) { \
    h[0] = s[0]; \
    h[1] = s[1]; \
} }

uint8_t atmp;
#define CHECK_FILTER(sname, nsbcd, npd, dcolor, isAdd, statoff) \
    if (CSPRITE_ENABLED(sname)) { \
    if (CSPRITE_YCHAROFF(sname) >= (NUM_ROWS - 1)) { \
        if ((filter[CSPRITE_XCHAROFF(sname)] & 0x0f) == (CSPRITE_DIGIT(sname))) { \
            if ((filter[CSPRITE_XCHAROFF(sname)] & 0x20) != 0x20) comboCount++; \
            filter[CSPRITE_XCHAROFF(sname)] &= 0xcf; \
            filter[CSPRITE_XCHAROFF(sname)] |= 0x20; \
            if (masked_##sname == 0) { nsbcd[0] = 0x10; } \
            else { nsbcd[0] = 0x02; } \
            isAdd = 1; \
            POKEY_WRITE.audf3 = 16; \
            volume = 0x0c; \
            POKEY_WRITE.audc3 = 0xac; \
        } \
        else \
        { \
            if ((filter[CSPRITE_XCHAROFF(sname)] & 0x10) != 0x10) comboCount--; \
            filter[CSPRITE_XCHAROFF(sname)] &= 0xcf; \
            filter[CSPRITE_XCHAROFF(sname)] |= 0x10; \
            if (masked_##sname == 0) { nsbcd[0] = 0x20; } \
            else { nsbcd[0] = 0x04; } \
            isAdd = 0; \
            POKEY_WRITE.audf3 = 65; \
            volume = 0x0c; \
            POKEY_WRITE.audc3 = 0xac; \
        } \
        rows[NUM_ROWS - 1][CSPRITE_XCHAROFF(sname)] = CSPRITE_DIGIT(sname) + dcolor; \
        CSPRITE_YCHAROFF(sname) = 0; \
        CSPRITE_YCHAROFF_NEW(sname) = 0; \
        NEW_PLAYER_DIGIT(sname, npd); \
    }}

char *dl = (char *)0x600;
int8_t hwhpos;
uint8_t hwsdelay;
uint8_t cc;
#define NEW_COMBO() { \
    for (cc = 0; cc < NUM_COLUMNS; cc++) \
    { \
        RANDASM(rl, rli, r); \
        filter[cc] = (r) + 0x10; \
        waitForVBLANKold(); \
        GTIA_WRITE.hitclr = 1; \
    } \
}


/* --------------------------------------------------------------------------------------------- */
/* Main loop                                                                                     */
/* --------------------------------------------------------------------------------------------- */
void main(void)
{
    GTIA_WRITE.prior = PRIOR_P03_PF03;

    /* Check for pal */
    waitForVBLANKold();
    currClockFrame = OS.rtclok[2]; \
    while (OS.rtclok[2] == currClockFrame)
    {
        if (ANTIC.vcount >= 133)
        {
            hz = 50;
            break;
        }
    }

    // Copy the display list to RAM
    memcpy((void *)0x0600, &dlist, sizeof(dlist));

    OS.color0 = 0xAa; // Blue
    OS.color1 = 0x2a; // Orange
    OS.color2 = 0xea; // Lime
    OS.color3 = 0x5a; // Pink
    OS.color4 = mainbgcolor;

    // ram char set at 0x8000
    OS.chbas = 0x80;

    NEW_PLAYER_DIGIT(P1, 0);
    NEW_PLAYER_DIGIT(P2, 1);
    NEW_PLAYER_DIGIT(P3, 2);
    NEW_PLAYER_DIGIT(P4, 3);

    memcpy(&p[0x10 << 3], charPlayerData, sizeof(charPlayerData));

    OS.pcolr0 = 10;
    OS.pcolr1 = 40;
    OS.pcolr2 = 56;
    OS.pcolr3 = 0x2f;

    POKEY_WRITE.audctl = 0;

    paddle1 = PEEK(PADDL0);
    paddle2 = PEEK(PADDL1);
    paddle3 = PEEK(PADDL2);
    paddle4 = PEEK(PADDL3);

    GTIA_WRITE.grafp0 = 0;
    GTIA_WRITE.sizep0 = sizep0;
    GTIA_WRITE.colpm0 = 46;
    GTIA_WRITE.colpf0 = 88;
    OS.pcolr0 = 0x55;
    GTIA_WRITE.prior = PRIOR_PF03_P03;

#ifdef MUSIC_ENABLED        
    RMTInitNotPlaying;
#endif
    RANDINIT(rli);
    RANDINIT(rli2);

    NEW_COMBO();

/* Enable all players to stress test */
#if 1
    CSPRITE_ENABLED(P1) = 1;
    CSPRITE_ENABLED(P2) = 1;
    CSPRITE_ENABLED(P3) = 1;
    CSPRITE_ENABLED(P4) = 1;
#endif

    waitForVBLANKold();

    /* Enable DLI */
    OS.vdslst = &dli_routine;
    ANTIC.nmien = 0xC0;
    OS.sdlst = (void *)0x600;

    vblanks = 0;

    /* Main loop */
    while (1)
    {
        waitForVBLANK();
        vblanks++;

        /* Sound effects */
        if (volume)
        {
            volume--;
            POKEY_WRITE.audc3 = 0xa0 | volume;
        }

        /* Update ghost */
        if (sizep0 == 0)
        {
            if (hwsdelay == 0)
            {
                hwhpos++;
                if (hwhpos > 47 && hwhpos < 98)
                {
                    hpos0--;
                }
                else{
                    hpos0++;
                }
            }
            else { hwsdelay--; hpos0 = 0; }

            if (PEEK(P0PF) & 0x0f)
            {
                tmp4 = 0;
                sizep0 = 1;
                hpos0 -= 4;
                pfh = PEEK(P0PF);
                if (pfh & 0x01) {
                    playerHitColor = OS.color0;
                    newScore1Bcd[0] = 0x30;
                    isAdd1 = 1;
                }
                else if (pfh & 0x02) {
                    playerHitColor = OS.color1;
                    newScore2Bcd[0] = 0x30;
                    isAdd2 = 1;
                }
                else if (pfh & 0x04)
                {
                    playerHitColor = OS.color2;
                    newScore3Bcd[0] = 0x30;
                    isAdd3 = 1;
                }
                else if (pfh & 0x08) {
                    playerHitColor = OS.color3;
                    newScore4Bcd[0] = 0x30;
                    isAdd4 = 1;
                }
                ptmp = 0x01;
                BCD_ADD(timer, ptmp, a);
                vblanks = 0;
                hwsdelay = 255;
            }
        } else if (sizep0 == 1)
        {
            if ((tmp4 & 0xf) == 0)
            {
                sizep0 = 3;
                hpos0 -= 8;
            }
        } else if ((tmp4 & 0xf) == 0)
        {
            sizep0 = 0;
            hpos0 = 100;
        }
        tmp4++;
        GTIA_WRITE.hitclr = 1;

        /* Update timer */
        if (vblanks >= hz)
        {
            vblanks -= hz;
            if ((timer[0] > 0) || (timer[1] > 0))
            {
                ptmp = 1;
                BCD_SUB(timer, ptmp);
            }
            if (gameState != GAME_NOT_STARTED)
            {
                /* Update the timer */
                UpdateStatusBCD(status1, 36, timer);
            }

            if (gameState == GAME_STARTED)
            {
                ptmp = 0x75;
                if ((teamScore[1] == 0) && (teamScore[0] <= ptmp)) teamScore[0] = 0;
                else 
                {
                    BCD_SUB(teamScore, ptmp);
                }
            }
            UpdateStatusBCD(status3, 16, teamScore);
        }

        if (gameState != GAME_STARTING)
        {
            PADDLE_UPDATE(P1, paddle1, PADDL0, PTRIG0);
            PADDLE_UPDATE(P2, paddle2, PADDL1, PTRIG1);
            PADDLE_UPDATE(P3, paddle3, PADDL2, PTRIG2);
            PADDLE_UPDATE(P4, paddle4, PADDL3, PTRIG3);

            CHECK_FILTER(P1, newScore1Bcd, 0, 0x10, isAdd1, 5);
            CHECK_FILTER(P2, newScore2Bcd, 1, 0x20, isAdd2, 13);
            CHECK_FILTER(P3, newScore3Bcd, 2, 0x30, isAdd3, 29);
            CHECK_FILTER(P4, newScore4Bcd, 3, 0xb0, isAdd4, 37);

            GTIA_WRITE.hposm0 = 48 + (CSPRITE_XCHAROFF(P1) << 2);
            GTIA_WRITE.hposm1 = 48 + (CSPRITE_XCHAROFF(P2) << 2);
            GTIA_WRITE.hposm2 = 48 + (CSPRITE_XCHAROFF(P3) << 2);
            GTIA_WRITE.hposm3 = 48 + (CSPRITE_XCHAROFF(P4) << 2);
            GTIA_WRITE.hitclr = 1;
        }

        CSPRITE_UNDRAW(P4);
        CSPRITE_UNDRAW(P3);
        CSPRITE_UNDRAW(P2);
        CSPRITE_UNDRAW(P1);

        CSPRITE_DRAW(P1);
        CSPRITE_DRAW(P2);
        CSPRITE_DRAW(P3);
        CSPRITE_DRAW(P4);

        switch (gameState)
        {
        case GAME_STARTED:
            //comboCount = NUM_COLUMNS;
            if (comboCount == NUM_COLUMNS)
            {
#ifdef MUSIC_ENABLED        
                RMTInitNotPlaying;
#endif
                CSPRITE_MASKED(P1) = 0;
                CSPRITE_MASKED(P2) = 0;
                CSPRITE_MASKED(P3) = 0;
                CSPRITE_MASKED(P4) = 0;
                CSPRITE_UNDRAW(P4);
                CSPRITE_UNDRAW(P3);
                CSPRITE_UNDRAW(P2);
                CSPRITE_UNDRAW(P1);

                CSPRITE_YCHAROFF(P1) = 0;
                CSPRITE_YCHAROFF(P2) = 0;
                CSPRITE_YCHAROFF(P3) = 0;
                CSPRITE_YCHAROFF(P4) = 0;

                /* Add 75 points to team score for each remaining second up to 99 */
                if (timer[1] != 0) timer[0] = 0x99;
                ptmp = 0x01;
                ptmp2 = 0x75;
                while (timer[0] != 0)
                {
                    GTIA_WRITE.hitclr = 1;
                    BCD_ADD(teamScore, ptmp2, b);
                    BCD_SUB(timer, ptmp);

                    if (teamScore[1] == 0x99)
                    {
                        timer[0] = 0;
                        timer[1] = 0;
                        teamScore[0] = 0;
                    }

                    UpdateStatusBCD(status3, 16, teamScore);
                    UpdateStatusBCD(status1, 36, timer);

                    if (teamScore[1] == 0x99)
                    {
                        break;
                    }

                    POKEY_WRITE.audf3 = 16;
                    volume = 0x0c;
                    POKEY_WRITE.audc3 = 0xac;

                    /* Pause the game for a bit */
                    vblanks = hz >> 2;
                    while (vblanks != 0)
                    {
                        waitForVBLANKold();
                        vblanks--;
                        if (volume)
                        {
                            volume--;
                            POKEY_WRITE.audc3 = 0xa0 | volume;
                        }
                    }
                    OS.color4 += 0x10;
                }                
                goto endGame;
            }

            /* Run the scores for testing */
            UPDATE_SCORE(p1Score, newScore1Bcd, isAdd1, P1, 5, q);
            UPDATE_SCORE(p2Score, newScore2Bcd, isAdd2, P2, 13, w);
            UPDATE_SCORE(p3Score, newScore3Bcd, isAdd3, P3, 29, e);
            UPDATE_SCORE(p4Score, newScore4Bcd, isAdd4, P4, 37, r);

            if (CSPRITE_ENABLED(P1)) UpdateStatusBCD(status3, 0, p1Score);
            if (CSPRITE_ENABLED(P2)) UpdateStatusBCD(status3, 8, p2Score);
            if (CSPRITE_ENABLED(P3)) UpdateStatusBCD(status3, 24, p3Score);
            if (CSPRITE_ENABLED(P4)) UpdateStatusBCD(status3, 32, p4Score);

            /* Timer expired? */
            if (timer[0] == 0 && timer[1] == 0)
            {
#ifdef MUSIC_ENABLED        
                RMTInitNotPlaying;
#endif
endGame:   
                waitForVBLANKold();
                UpdateStatusBCD(status1, 36, timer);

                /* Update player scores with matched or mismatched filters */
                for (ptmp2 = 0; ptmp2 < NUM_COLUMNS; ptmp2++)
                {
                    /* Pause the game for a bit */
                    GTIA_WRITE.hitclr = 1;
                    vblanks = hz >> 1;
                    while (vblanks != 0)
                    {
                        waitForVBLANKold();
                        vblanks--;
                        if (volume)
                        {
                            volume--;
                            POKEY_WRITE.audc3 = 0xa0 | volume;
                        }
                    }                    
                    OS.color4 += 0x10;

                    newScore1Bcd[0] = 0x20;
                    ptmp3 = filter[ptmp2];
                    isRed = ptmp3 & 0x10;
                    ptmp3 &= 0x0f;
                    if (isRed)
                    {
                        // Not matched
                        isAdd1 = 0;
                        POKEY_WRITE.audf3 = 65;
                        volume = 0x0c;
                        POKEY_WRITE.audc3 = 0xac;
                    }
                    else
                    {
                        // Matched value
                        isAdd1 = 1;
                        POKEY_WRITE.audf3 = 16;
                        volume = 0x0c;
                        POKEY_WRITE.audc3 = 0xac;
                    }
                    /* Update player score */
                    switch (rows[NUM_ROWS - 1][ptmp2] & 0xF0)
                    {
                        case 0x10: /* P1 */
                            UPDATE_SCORE(p1Score, newScore1Bcd, isAdd1, P1, 5, z);
                            if (CSPRITE_ENABLED(P1))
                            {
                                UpdateStatusBCD(status3, 0, p1Score);
                            }
                            break;
                        case 0x20: /* P2 */
                            UPDATE_SCORE(p2Score, newScore1Bcd, isAdd1, P2, 13, x);
                            if (CSPRITE_ENABLED(P2))
                            {
                                UpdateStatusBCD(status3, 8, p2Score);
                            } 
                            break;
                        case 0x30: /* P3 */
                            UPDATE_SCORE(p3Score, newScore1Bcd, isAdd1, P3, 29, c);
                            if (CSPRITE_ENABLED(P3))
                            {
                                UpdateStatusBCD(status3, 24, p3Score);
                            } 
                            break;
                        case 0xb0: /* P4 */
                            UPDATE_SCORE(p4Score, newScore1Bcd, isAdd1, P4, 37, v);
                            if (CSPRITE_ENABLED(P4))
                            {
                                UpdateStatusBCD(status3, 32, p4Score);
                            } 
                            break;
                        /* No player in column */
                        default:
                            break;
                    }
                    rows[NUM_ROWS - 1][ptmp2] = 0;
                    filter[ptmp2] = 0;
                }        
                /* End game */
                UPDATE_HIGH_SCORE(p1Score, p1ScoreHi);
                UPDATE_HIGH_SCORE(p2Score, p2ScoreHi);
                UPDATE_HIGH_SCORE(p3Score, p3ScoreHi);
                UPDATE_HIGH_SCORE(p4Score, p4ScoreHi);
                UPDATE_HIGH_SCORE(teamScore, teamScoreHi);

                if (CSPRITE_ENABLED(P1))
                {
                    UpdateStatusBCD(status3, 0, p1Score);
                    UpdateStatusBCD(status4, 2, p1ScoreHi);
                }
                if (CSPRITE_ENABLED(P2))
                {
                    UpdateStatusBCD(status3, 8, p2Score);
                    UpdateStatusBCD(status4, 10, p2ScoreHi);
                } 
                if (CSPRITE_ENABLED(P3))
                {
                    UpdateStatusBCD(status3, 24, p3Score);
                    UpdateStatusBCD(status4, 26, p3ScoreHi);
                } 
                if (CSPRITE_ENABLED(P4))
                {
                    UpdateStatusBCD(status3, 32, p4Score);
                    UpdateStatusBCD(status4, 34, p4ScoreHi);
                } 

                timer[0] = 0;
                timer[1] = 0;
                gameState = GAME_NOT_STARTED;

                waitForVBLANKold();

                memset(&status3[21], 0, 3);

                /* Pause the game for a bit */
                vblanks = 1;
                while (vblanks != 0)
                {
                    waitForVBLANKold();
                    vblanks++;
                    if (vblanks < NUM_ROWS) { memset(&rows[vblanks], 0, NUM_COLUMNS); }
                }

                /* Reseed the combination */
                NEW_COMBO();
            }
            break;
        case GAME_STARTING:
            /* Invert the timer characters when the game is starting */
            status1[36] |= 0x80;
            status1[37] |= 0x80;
            status1[38] |= 0x80;
            status1[39] |= 0x80;

            /* Timer expired? */
            if (timer[0] == 0 && timer[1] == 0)
            {
                /* Start game */
                OS.color4 = mainbgcolor;
                vblanks = 0;
                teamScore[1] = 0x90;
                teamScore[0] = 0x00;
                timer[0] = 0x20;
                timer[1] = 0x01;
                timerStarted = 0;
                CSPRITE_BUTTON_COUNT_LAST(P1) = CSPRITE_BUTTON_COUNT(P1) = 0;
                CSPRITE_BUTTON_COUNT_LAST(P2) = CSPRITE_BUTTON_COUNT(P2) = 0;
                CSPRITE_BUTTON_COUNT_LAST(P3) = CSPRITE_BUTTON_COUNT(P3) = 0;
                CSPRITE_BUTTON_COUNT_LAST(P4) = CSPRITE_BUTTON_COUNT(P4) = 0;

                comboCount = 0;
                memset(&rows[NUM_ROWS - 1], 0, NUM_COLUMNS);
                NEW_COMBO();

                CSPRITE_MASKED(P1) = 0;
                CSPRITE_MASKED(P2) = 0;
                CSPRITE_MASKED(P3) = 0;
                CSPRITE_MASKED(P4) = 0;
                CSPRITE_UNDRAW(P4);
                CSPRITE_UNDRAW(P3);
                CSPRITE_UNDRAW(P2);
                CSPRITE_UNDRAW(P1);

                CSPRITE_YCHAROFF(P1) = 0;
                CSPRITE_YCHAROFF(P2) = 0;
                CSPRITE_YCHAROFF(P3) = 0;
                CSPRITE_YCHAROFF(P4) = 0;
                
                newScore1Bcd[0] = 0;
                newScore1Bcd[1] = 0;
                newScore2Bcd[0] = 0;
                newScore2Bcd[1] = 0;
                newScore3Bcd[0] = 0;
                newScore3Bcd[1] = 0;
                newScore4Bcd[0] = 0;
                newScore4Bcd[1] = 0;

                p1Score[0] = 0;
                p1Score[1] = 0x02;
                p2Score[0] = 0;
                p2Score[1] = 0x02;
                p3Score[0] = 0;
                p3Score[1] = 0x02;
                p4Score[0] = 0;
                p4Score[1] = 0x02;
                

                gameState = GAME_STARTED;
            }

            break;
        case GAME_NOT_STARTED:
            /* Disable attract mode */
            POKE(77, 0);

            /* Short press enables player, long press starts game */
            PLAYER_START(P1, PTRIG0);
            PLAYER_START(P2, PTRIG1);
            PLAYER_START(P3, PTRIG2);
            PLAYER_START(P4, PTRIG3);

            if (CSPRITE_ENABLED(P1))
            {
                UpdateStatusBCD(status3, 0, p1Score);
                UpdateStatusBCD(status4, 2, p1ScoreHi);
            }
            if (CSPRITE_ENABLED(P2))
            {
                UpdateStatusBCD(status3, 8, p2Score);
                UpdateStatusBCD(status4, 10, p2ScoreHi);
            } 
            if (CSPRITE_ENABLED(P3))
            {
                UpdateStatusBCD(status3, 24, p3Score);
                UpdateStatusBCD(status4, 26, p3ScoreHi);
            } 
            if (CSPRITE_ENABLED(P4))
            {
                UpdateStatusBCD(status3, 32, p4Score);
                UpdateStatusBCD(status4, 34, p4ScoreHi);
            } 
            UpdateStatusBCD(status3, 16, teamScore);
            UpdateStatusBCD(status4, 18, teamScoreHi);

            CSPRITE_BUTTON_COUNT_LAST(P1) = CSPRITE_BUTTON_COUNT(P1);
            CSPRITE_BUTTON_COUNT_LAST(P2) = CSPRITE_BUTTON_COUNT(P2);
            CSPRITE_BUTTON_COUNT_LAST(P3) = CSPRITE_BUTTON_COUNT(P3);
            CSPRITE_BUTTON_COUNT_LAST(P4) = CSPRITE_BUTTON_COUNT(P4);
            GTIA_WRITE.hitclr = 1;
        default:
            break;
        }
    };
}
